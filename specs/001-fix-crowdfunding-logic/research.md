# Research: Fix Crowdfunding Logic and UI

**Feature**: Fix Crowdfunding Logic and UI
**Status**: Research Complete

## Technical Context

- **Language**: Dart / Flutter
- **State Management**: Provider
- **Data Storage**: Hive (local DB)
- **Charting**: fl_chart

## Current Implementation Analysis

### 1. CrowdfundingService
- **Current Logic**: Projects future flows based on *current* asset state (quantity, yield).
- **Limitations**:
  - Does not simulate the *past* evolution of liquidity.
  - Does not account for `CapitalRepayment` transactions in the `Asset.quantity` calculation (potential bug).
  - Does not handle the "Account Liquidity" concept (deposits/withdrawals).
  - Does not recalculate future interest based on partial repayments dynamically (it assumes static capital).

### 2. CrowdfundingProjectionChart
- **Current Logic**:
  - Calculates projections internally (partially duplicating service logic).
  - Uses `SingleChildScrollView` for horizontal scrolling, but the width calculation might be insufficient or the user experience is poor.
  - Displays "Invested Capital", "Cumulative Interest", "Available Liquidity".
- **Issues**:
  - "Available Liquidity" is calculated as cumulative returns, not including Deposits/Purchases.
  - Logic is tightly coupled to the widget.

### 3. Data Models
- **TransactionType**: Includes `Deposit`, `Buy`, `Interest`, `CapitalRepayment`.
- **Asset**: Has `repaymentType`, `expectedYield`.
- **Issue**: `Asset.quantity` getter only considers `Buy` and `Sell`. It ignores `CapitalRepayment`, which means the "invested capital" doesn't decrease after a partial repayment in the current model.

## Decisions

### Decision 1: Implement a Full Simulation Engine
- **Choice**: Create a `CrowdfundingSimulator` class (or method in Service) that reconstructs the account state from the beginning of time.
- **Rationale**: To correctly calculate "Account Liquidity" and handle partial repayments, we must process transactions in chronological order.
- **Algorithm**:
  1.  Initialize `liquidity = 0`.
  2.  Fetch all transactions for Crowdfunding assets + Deposits/Withdrawals linked to Crowdfunding (if distinguishable). *Note: We might need to assume all Deposits are available, or filter by a specific "Crowdfunding" account if it exists. For now, we'll assume a "Virtual Crowdfunding Account" derived from transactions tagged with Crowdfunding assets, plus explicit Deposits if we can link them. If not, we might just track the "Cash Flow" generated by the projects.*
  *Correction*: The user says "on fait un dépot". We need to know *which* deposits are for crowdfunding. If there's no separate account, maybe we just track the *net cash flow* of the crowdfunding strategy.
  *Refinement*: We will track "Liquidity" as: `Sum(Deposits) - Sum(Buys) + Sum(Sells/Repayments) + Sum(Interests)`.
  3.  Iterate through history:
      - `Deposit`: +Liquidity
      - `Buy`: -Liquidity, +ProjectCapital
      - `Interest`: +Liquidity
      - `CapitalRepayment`: +Liquidity, -ProjectCapital
  4.  Project future:
      - Continue from current state.
      - Generate future Interest/Repayment events based on `ProjectCapital` and `RepaymentType`.
      - Apply them to Liquidity.

### Decision 2: Fix Asset.quantity Logic (or Bypass it)
- **Choice**: Bypass `Asset.quantity` for the simulation. Use the simulated `ProjectCapital`.
- **Rationale**: Changing `Asset.quantity` might have side effects on other parts of the app (Portfolio valuation). For the *projection*, we want the *remaining outstanding capital*. We will calculate this dynamically in the simulation.

### Decision 3: Enhance Chart UI
- **Choice**: Keep `fl_chart` but ensure the data source is the new Simulation.
- **Improvement**: Ensure the X-axis is properly scaled and the container width allows for comfortable scrolling (e.g., 50px per month).

## Alternatives Considered

- **Alternative**: Just fix `Asset.quantity`.
  - **Pros**: Simpler.
  - **Cons**: Doesn't solve the "Account Liquidity" history (Deposits). Doesn't handle the dynamic recalculation of interest if the yield is based on *initial* vs *remaining* capital (though usually it's remaining).

## Unknowns / Risks

- **Deposits**: How do we identify a "Deposit" specifically for Crowdfunding?
  - *Assumption*: We might not be able to. We might have to assume "Liquidity" is just the uninvested cash *generated* by the projects, plus any "Deposit" transaction that the user *manually* assigns to this view (if possible).
  - *Workaround*: For this feature, we will look for `TransactionType.Deposit` where `assetType` is `RealEstateCrowdfunding` (if that field is allowed on Deposits) or just assume a starting balance of 0 and allow negative liquidity (showing need for deposit) or just track flows.
  - *User Input*: "on fait un dépot". This implies we can create a Deposit transaction. We should ensure the Transaction Form allows creating a Deposit linked to Crowdfunding (or just a generic deposit).
  - *Decision*: We will include all `TransactionType.Deposit` in the simulation if they are not linked to other specific strategies, OR we will filter by a specific flag. Given the current data model, `Transaction` has `assetType`. We can filter Deposits by `assetType == RealEstateCrowdfunding`.

